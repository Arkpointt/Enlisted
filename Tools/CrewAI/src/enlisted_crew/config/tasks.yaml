# Enlisted CrewAI Task Definitions
# Supports feature development, content creation, and validation workflows

# =============================================================================
# RESEARCH & ANALYSIS TASKS
# =============================================================================

analyze_systems:
  description: >
    Research and analyze how Enlisted systems integrate for a feature:
    
    Feature: {feature_name}
    Related Systems: {related_systems}
    
    Tasks:
    1. Identify relevant C# files and their responsibilities
    2. Trace data flows between systems (Orchestrator, Managers, Content)
    3. Find integration points where new code would connect
    4. Identify existing patterns to follow
    5. Note any constraints (save/load, performance, mod compatibility)
  expected_output: >
    Systems analysis report with:
    - List of relevant files with their responsibilities
    - Data flow diagram (text-based)
    - Integration points for new feature
    - Existing patterns to follow
    - Constraints and considerations
  agent: systems_analyst

analyze_codebase:
  description: >
    Analyze existing C# implementation to understand patterns:
    
    Focus: {focus_area}
    Files: {file_paths}
    
    Tasks:
    1. Read and understand the existing code
    2. Identify patterns (data models, method signatures, error handling)
    3. Find save/load handling (SyncData implementations)
    4. Note any Harmony patches that might conflict
    5. Check for existing tests or validation
  expected_output: >
    Code analysis report with:
    - Summary of existing implementation
    - Key patterns identified
    - Save/load considerations
    - Potential conflicts or dependencies
    - Recommendations for integration
  agent: code_analyst

analyze_content_structure:
  description: >
    Analyze JSON content structure and delivery pipeline:
    
    Content Type: {content_type}
    Files: {file_paths}
    
    Tasks:
    1. Review JSON structure and schema compliance
    2. Trace content ID through C# delivery system
    3. Identify how requirements/triggers are processed
    4. Note any gaps in content coverage
    5. Check localization completeness
  expected_output: >
    Content analysis report with:
    - Schema compliance status
    - Delivery pipeline (JSON â†’ C# â†’ UI)
    - Content gaps identified
    - Localization status
    - Integration recommendations
  agent: content_analyst

investigate_bug:
  description: >
    Investigate a bug or crash reported by the user:
    
    Bug Description: {bug_description}
    Error Codes: {error_codes}
    Reproduction Steps: {repro_steps}
    
    INVESTIGATION PROCESS:
    1. Search mod debug logs for error codes (E-*, W-*) and stack traces
    2. Check Conflicts-A_*.log for Harmony patch conflicts with other mods
    3. Check native crash logs if game hard-crashed (no error codes visible)
    4. Identify the failing method from stack trace
    5. Read the relevant C# source files
    6. Trace the bug to root cause
    7. Check for related patterns that might have same issue
    8. Propose fix with minimal code changes
    
    ERROR CODE MEANINGS:
    - E-ENCOUNTER-* = Battle/menu state issues (PlayerEncounter, MapEvent)
    - E-SAVELOAD-* = Save corruption or data migration failures
    - E-QM-* = Quartermaster UI issues
    - E-CAMPUI-* = Camp menu display failures
    - E-CONTENT-* = JSON content loading/processing errors
    - W-DLC-* = Missing Naval/WarSails DLC (NOT a bug - expected gating)
    - W-REFLECT-* = Native API changed between Bannerlord versions
    
    LOG LOCATIONS (check in order):
    
    1. MOD SESSION LOG (primary - has E-*/W-* codes):
       - <bannerlord>/Modules/Enlisted/Debugging/Session-A_*.log (newest)
       - Session-B/C for previous sessions
       - Exceptions include full stack traces (de-duplicated)
    
    2. MOD CONFLICT LOG (for mod compatibility issues):
       - <bannerlord>/Modules/Enlisted/Debugging/Conflicts-A_*.log
       - Shows Harmony patch conflicts, module health, catalog status
    
    3. NATIVE CRASH LOGS (for hard game crashes):
       - C:\ProgramData\Mount and Blade II Bannerlord\logs\crashlist.txt
       - C:\ProgramData\Mount and Blade II Bannerlord\logs\CrashUploader.*.txt
       - rgl_log.txt in game directory (engine errors)
    
    DEBUG TOOLS (for reproduction):
    - settings.json: "EnableDebugTools": true enables in-game debug menu
    - Debug menu includes: force events, clear cooldowns, trigger muster, give XP
  expected_output: >
    Bug investigation report with:
    - Error codes found and their meaning
    - Stack trace analysis (from mod logs AND/OR native crash logs)
    - Harmony conflict status (if relevant)
    - Root cause identification
    - Affected files and line numbers
    - Proposed fix (code diff or description)
    - Related code that may need similar fixes
    - Confidence level (certain/likely/speculative)
    - Reproduction steps verified
  agent: code_analyst

# =============================================================================
# FEATURE DESIGN TASKS
# =============================================================================

design_feature:
  description: >
    Design technical specification for a new feature:
    
    Feature: {feature_name}
    Description: {description}
    Related Docs: {related_docs}
    
    Requirements:
    1. Create data models with field types and purposes
    2. Define method signatures with parameters and returns
    3. List all files that need changes (C#, JSON, docs)
    4. Design integration with existing systems
    5. Plan save/load handling
    6. Consider error handling and edge cases
    7. Create phased implementation plan
    
    Reference: ORCHESTRATOR-OPPORTUNITY-UNIFICATION.md for spec format
  expected_output: >
    Technical specification document with:
    - Problem statement and goals
    - Data model definitions (C# classes)
    - Method signatures with XML doc comments
    - File change list (create/modify)
    - Integration points with existing systems
    - Save/load considerations
    - Error handling plan
    - Phased implementation roadmap
  agent: feature_architect

review_feature_design:
  description: >
    Review a feature design for completeness and correctness:
    
    Specification: {spec_content}
    
    Review criteria:
    1. Does design follow Enlisted patterns?
    2. Are all integration points identified?
    3. Is save/load handling complete?
    4. Are error cases covered?
    5. Is the implementation plan realistic?
    6. Are there balance concerns?
  expected_output: >
    Design review report with:
    - Pattern compliance assessment
    - Missing integration points
    - Save/load concerns
    - Error handling gaps
    - Implementation feasibility
    - Balance recommendations
    - Approval or required changes
  agent: balance_analyst

# =============================================================================
# IMPLEMENTATION TASKS
# =============================================================================

implement_csharp:
  description: >
    Implement C# code according to specification:
    
    Specification: {spec_content}
    Files to create/modify: {file_list}
    
    Requirements:
    1. Follow Enlisted code style (Allman braces, _camelCase, XML docs)
    2. Add new files to Enlisted.csproj
    3. Use proper Bannerlord patterns (TextObject, GiveGoldAction, etc.)
    4. Implement SyncData for saveable state
    5. Add appropriate logging with ModLogger
    6. Handle null checks and edge cases
    7. Ensure .NET Framework 4.7.2 compatibility
  expected_output: >
    Implementation report with:
    - Code created/modified (file paths)
    - Patterns followed
    - Save/load implementation
    - Build status
    - Any deviations from spec with justification
  agent: csharp_implementer

implement_content:
  description: >
    Create JSON content according to specification:
    
    Content Type: {content_type}
    Requirements: {requirements}
    
    Requirements:
    1. Follow event-system-schemas.md exactly
    2. Use proper field ordering (fallback after ID)
    3. Include all required fields (tooltips, effects)
    4. Follow writing-style-guide.md for narrative text
    5. Use thematic skill aliases where appropriate
    6. Ensure balanced effects (reference systems-integration-analysis.md)
  expected_output: >
    Content implementation report with:
    - JSON files created/modified
    - Schema validation status
    - Style compliance status
    - Balance assessment
    - Localization strings needed
  agent: content_author

# =============================================================================
# VALIDATION TASKS
# =============================================================================

validate_all:
  description: >
    Run comprehensive validation on all project content:
    1. Execute validate_content.py to check all JSON files
    2. Run sync_event_strings.py to verify localization
    3. Run dotnet build to check C# compilation
    4. Check code style compliance
    
    Report all errors with severity and file locations.
  expected_output: >
    A structured validation report listing:
    - JSON validation errors (file, line, issue)
    - Missing localization strings
    - Build errors or warnings
    - Code style issues
    - Overall pass/fail status
  agent: qa_agent

validate_implementation:
  description: >
    Validate a feature implementation against its specification:
    
    Specification: {spec_content}
    Implementation files: {file_list}
    
    Checks:
    1. All files in spec were created/modified
    2. Code follows spec's data models and methods
    3. Build succeeds with no errors
    4. Content validates with no errors
    5. Localization is complete
    6. Code style is compliant
  expected_output: >
    Implementation validation report with:
    - Spec compliance checklist
    - Build status
    - Content validation status
    - Localization status
    - Style compliance
    - Issues to fix before merge
  agent: qa_agent

validate_content_file:
  description: >
    Validate a specific content file against schema and style:
    
    File: {file_path}
    
    Checks:
    - Schema compliance (field ordering, required fields)
    - Option count rules (2-4, never 1)
    - Tooltip presence and length (<80 chars)
    - Writing style compliance
    - Skill names and effect values
  expected_output: >
    Detailed validation report with:
    - Schema violations
    - Style violations
    - Balance concerns
    - Suggested fixes
    - Pass/fail determination
  agent: content_analyst

# =============================================================================
# REVIEW TASKS
# =============================================================================

review_code:
  description: >
    Review C# code changes for Enlisted-specific issues:
    
    Files: {file_paths}
    
    Focus areas:
    - SaveableTypeDefiner registration
    - TextObject localization patterns
    - Hero/settlement null safety
    - Equipment iteration patterns
    - Gold/reputation change APIs
    - Allman braces, _camelCase naming
  expected_output: >
    Code review report with:
    - Critical issues (will cause crashes/save breaks)
    - Warnings (potential problems)
    - Style issues
    - Pattern compliance
    - Approval or required fixes
  agent: code_analyst

review_balance:
  description: >
    Review content for game balance:
    
    Target: {target}
    
    Checks:
    - Skill XP rewards match tier and difficulty
    - Gold amounts appropriate for tier
    - Reputation effects create meaningful tradeoffs
    - Company needs effects are proportional
    - Order events include skillXp
  expected_output: >
    Balance review report with:
    - Effects summary
    - Balance concerns
    - Tier appropriateness
    - Suggested adjustments
  agent: balance_analyst

# =============================================================================
# DOCUMENTATION TASKS
# =============================================================================

create_planning_doc:
  description: >
    Create a planning/design document for a proposed feature (NOT yet implemented):
    
    Feature: {feature_name}
    Description: {description}
    Related Systems: {related_systems}
    
    PLANNING DOC RULES:
    - Place in docs/ANEWFEATURE/ (or Planning/ if renamed)
    - Set Status: ðŸ“‹ Planning
    - DO NOT update INDEX.md Feature Lookup (not implemented yet)
    - DO NOT update AI context docs (no code exists yet)
    - DO NOT update validators (no schema changes yet)
    - DO reference existing docs as Related Docs
    
    Structure:
    1. Problem Statement - What problem does this solve?
    2. Current State - How do existing systems work today?
    3. Proposed Design - Technical approach
    4. Integration Points - Which files/systems are affected?
    5. Implementation Phases - Suggested order of work
    6. Open Questions - Unresolved design decisions
  expected_output: >
    Planning document created with:
    - File path (in ANEWFEATURE/ or Planning/)
    - Status: ðŸ“‹ Planning
    - Summary of proposed changes
    - NO updates to other docs (planning only)
  agent: documentation_maintainer

sync_documentation:
  description: >
    Synchronize documentation after IMPLEMENTED code changes. Only run this task
    when actual code/content has been created or modified - NOT for planning docs.
    
    Changed Files: {changed_files}
    Feature Area: {feature_area}
    
    WHEN TO RUN THIS TASK:
    - After C# code is written and builds
    - After JSON content is created and validates
    - After config files are modified
    - NOT after creating planning/design docs (use create_planning_doc instead)
    
    SYNC TASKS:
    1. Identify all docs that reference the changed code
    2. Update feature doc Status field if implementation complete
    3. Update "Last Updated" date with brief change summary
    4. Verify INDEX.md Feature Lookup entries are current
    5. Check if BLUEPRINT.md needs architecture updates
    6. Update CrewAI agent/task configs if tools changed
    7. Ensure cross-references between docs are valid
    
    AI CONTEXT SYNC (CRITICAL - stale context breaks AI assistants):
    If game systems change (tier thresholds, rep ranges, Company Needs, etc.):
    - Update docs_tools.py load_domain_context_tool
    - Update Tools/AGENT-WORKFLOW.md Balance Agent Checklist
    - Update agents.yaml backstories mentioning those values
    - Update validate_content.py if it enforces those values
    If JSON schema rules change:
    - Update Tools/Validation/validate_content.py
    - Update docs/Features/Content/event-system-schemas.md
    - Update VALIDATION_BASELINE.md if expected warnings change
    If CrewAI agents/tools change:
    - Update Tools/CrewAI/README.md
    If Warp workflow changes:
    - Update Tools/AGENT-WORKFLOW.md
    
    INCREMENTAL IMPROVEMENTS (fix on every doc you touch):
    - Ensure standard header format: # Title, **Summary:**, **Status:**, **Last Updated:**, **Related Docs:**
    - Fix filename casing if wrong (SCREAMING-CASE.md â†’ screaming-case.md)
    - Fix broken internal links (../Gameplay/ â†’ ../Campaign/)
    - Move misplaced docs (ANEWFEATURE/reference.md â†’ Reference/)
    - Remove duplicate files (prefer Reference/ or Features/ over ANEWFEATURE/)
    
    IMPORTANT: Small improvements compound. Fix issues in docs you touch.
  expected_output: >
    Documentation sync report with:
    - Docs updated (with change summary)
    - Status field changes
    - INDEX.md updates needed
    - Cross-reference fixes
    - AI context sync updates (CrewAI, Warp, domain context)
    - Incremental improvements made (renames, link fixes, header standardization)
    - Any outstanding doc debt
  agent: documentation_maintainer

audit_documentation:
  description: >
    Audit documentation for accuracy against current codebase:
    
    Scope: {scope}
    
    Checks:
    1. Feature doc Status matches implementation reality
    2. Code examples in docs compile and match actual code
    3. File paths referenced in docs exist
    4. Method signatures in docs match code
    5. Configuration examples match actual config files
    6. INDEX.md entries point to existing docs
    
    Report discrepancies requiring updates.
  expected_output: >
    Documentation audit report with:
    - Stale docs needing updates
    - Broken references
    - Outdated code examples
    - Status field corrections needed
    - Priority ranking (critical/high/medium/low)
  agent: documentation_maintainer

# =============================================================================
# WORKFLOW TASKS (Multi-Agent)
# =============================================================================

full_feature_workflow:
  description: >
    Complete feature development workflow:
    
    Feature: {feature_name}
    Description: {description}
    
    Phases:
    1. Research - Analyze related systems and code
    2. Design - Create technical specification
    3. Review - Validate design before implementation
    4. Implement - Create C# and JSON content
    5. Validate - Run all checks, ensure quality
  expected_output: >
    Feature completion report with:
    - Research findings summary
    - Approved specification
    - Implementation summary
    - Validation results
    - Ready for commit confirmation
  agent: qa_agent
  context:
    - analyze_systems_task
    - design_feature_task
    - implement_csharp_task
    - validate_implementation_task

full_content_workflow:
  description: >
    Complete content creation workflow:
    
    Content Type: {content_type}
    Theme: {theme}
    Requirements: {requirements}
    
    Phases:
    1. Analyze - Review existing content patterns
    2. Create - Write JSON content
    3. Validate - Check schema and style
    4. Balance - Review effects and rewards
    5. Localize - Ensure strings are synced
  expected_output: >
    Content completion report with:
    - Content files created
    - Validation results
    - Balance assessment
    - Localization status
    - Ready for commit confirmation
  agent: qa_agent
  context:
    - analyze_content_structure_task
    - implement_content_task
    - validate_content_file_task
    - review_balance_task
