# Decision Orchestration Architecture

**Summary:** Decisions are orchestrated through the camp opportunity system. The camp intelligently generates activities based on world state, time of day, player behavior, and context. Players interact with what's available, not static menus.

**Status:** ✅ Implemented  
**Last Updated:** 2025-12-31  
**Related Docs:** [Camp Simulation System](../Campaign/camp-simulation-system.md), [Content System Architecture](content-system-architecture.md)

---

## Core Philosophy

**The camp has its own life.** Soldiers train, socialize, rest, and work based on:
- Time of day (dawn drills, dusk gambling, night rest)
- World state (combat readiness, supply situation, morale)
- Player history (learns preferences, avoids repetition)
- Context (at sea vs on land, in garrison vs on march)

**Players observe and participate, not command.** You're one soldier in a company. The camp decides when training happens, when card games form, when rest is appropriate. You choose whether to engage.

---

## Two-Layer Architecture

### Layer 1: Opportunities (Menu Display)

**File:** `ModuleData/Enlisted/Decisions/camp_opportunities.json`

Opportunities are **menu entries** that describe what's happening in camp:
- "The sergeant is running drills in the yard"
- "A card game has started near the cook fires"
- "Your bedroll looks inviting"

**Generated by:** `CampOpportunityGenerator` based on:
- Current day phase (dawn/midday/dusk/night)
- World situation (combat readiness, supply pressure)
- Player state (fatigue, on duty, preferences)
- History (cooldowns, recent engagement)

**Properties:**
```json
{
  "id": "opp_weapon_drill",
  "type": "training",
  "title": "Weapon Drill",
  "description": "The sergeant is running drills in the yard...",
  "action": "Join the drill",
  "targetDecision": "dec_training_drill",
  "scheduledPhase": "Midday",
  "validPhases": ["Dawn", "Midday"],
  "cooldownHours": 18,
  "baseFitness": 55
}
```

### Layer 2: Decisions (Event Content)

**File:** `ModuleData/Enlisted/Decisions/decisions.json`

Decisions are **event content** that fires when an opportunity is engaged:
- Options to choose from
- Costs and rewards
- Result text

**Triggered by:** Opportunities via `targetDecision` field

**Properties:**
```json
{
  "id": "dec_training_drill",
  "category": "decision",
  "title": "Weapon Drill",
  "setup": "The sergeant barks orders...",
  "options": [
    {
      "id": "drill_hard",
      "text": "Push yourself hard",
      "effects": { "fatigue": 2, "weapon_skill": 5 }
    },
    {
      "id": "drill_normal",
      "text": "Keep pace with the others",
      "effects": { "fatigue": 1, "weapon_skill": 3 }
    }
  ]
}
```

---

## Flow Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                   WORLD STATE                               │
│  • Time of day (dawn/midday/dusk/night)                     │
│  • Combat readiness, supply pressure, morale                │
│  • Player fatigue, on duty status, preferences              │
│  • Sea vs land, garrison vs march                           │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────────┐
│            CAMP OPPORTUNITY GENERATOR                       │
│  • Analyzes context (time, location, activity level)       │
│  • Generates 0-3 opportunities                              │
│  • Scores fitness (relevance to current situation)          │
│  • Filters by cooldowns, requirements, history              │
│  • Learns player preferences over time                      │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────────┐
│                 OPPORTUNITIES MENU                          │
│  ┌───────────────────────────────────────────────┐          │
│  │ OPPORTUNITIES                                 │          │
│  │   • Weapon Drill (Midday)                     │          │
│  │   • Card Game (Dusk)                          │          │
│  │   • Rest in Tent (Night)                      │          │
│  └───────────────────────────────────────────────┘          │
│  ┌───────────────────────────────────────────────┐          │
│  │ TRAINING (none available)                     │          │
│  │ SOCIAL (none available)                       │          │
│  │ CAMP LIFE (none available)                    │          │
│  └───────────────────────────────────────────────┘          │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ↓ Player clicks opportunity
                     │
┌─────────────────────────────────────────────────────────────┐
│              SCHEDULING SYSTEM                              │
│  • Immediate opportunities → Fire now                       │
│  • Scheduled opportunities → Commit for later               │
│    "You've committed to weapon drill at midday"             │
│  • Fires automatically at scheduled phase                   │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────────┐
│              DECISION DELIVERY                              │
│  • Looks up targetDecision (dec_training_drill)             │
│  • Converts to EventDefinition                              │
│  • Queues for delivery via EventDeliveryManager             │
│  • Shows popup with options                                 │
│  • Records cooldown after non-cancel option selected        │
└─────────────────────────────────────────────────────────────┘
```

---

## Key Components

### CampOpportunityGenerator

**File:** `src/Features/Camp/CampOpportunityGenerator.cs`

**Responsibilities:**
- Generate 0-3 opportunities based on current context
- Score fitness (how relevant is this opportunity right now?)
- Filter by requirements (tier, time, cooldowns, sea/land)
- Track player commitments (scheduled activities)
- Learn player preferences over time
- Fire scheduled commitments at phase boundaries

**Key Methods:**
```csharp
// Main entry point - generates opportunities for current context
public List<CampOpportunity> GenerateCampLife()

// Commits player to a scheduled activity
public void CommitToOpportunity(CampOpportunity opportunity)

// Fires scheduled commitments at phase boundaries (hourly tick)
private void FireScheduledCommitments(string phase, int day)
```

### DecisionManager

**File:** `src/Features/Content/DecisionManager.cs`

**Responsibilities:**
- Convert opportunities to decision availability
- Check decision requirements (tier, time, cooldowns, sea/land)
- Track "currently showing" state to prevent spam-clicking
- Provide filtered lists for menu display

**Key Methods:**
```csharp
// Gets orchestrated opportunities for menu display
public IReadOnlyList<DecisionAvailability> GetAvailableOpportunities()

// Gets static decisions for a section (now returns empty - legacy)
public IReadOnlyList<DecisionAvailability> GetAvailableDecisionsForSection(string section)

// Checks if a decision meets all requirements
public DecisionAvailability CheckAvailability(DecisionDefinition decision)
```

### DecisionCatalog

**File:** `src/Features/Content/DecisionCatalog.cs`

**Responsibilities:**
- Load decisions from JSON files
- Index by ID for fast lookup
- Categorize by delivery method (player-initiated vs automatic)

**Key Change (2025-12-31):**
```csharp
// OLD: Decisions with "dec_" prefix were player-initiated (static menu items)
decision.IsPlayerInitiated = id.StartsWith("player_") || id.StartsWith("dec_");

// NEW: Decisions are orchestrated only (no static menu items)
decision.IsPlayerInitiated = id.StartsWith("player_"); // Legacy only
```

---

## Scheduling System

### Immediate vs Scheduled

**Immediate Opportunities:**
- `"immediate": true` in opportunity JSON
- Fire right away when clicked
- Examples: Equipment maintenance, letter writing

**Scheduled Opportunities:**
- Have `scheduledPhase` (dawn/midday/dusk/night)
- Player commits to activity at specific time
- Greys out in menu until scheduled time
- Fires automatically at phase boundary
- Examples: Training drills (midday), card games (dusk), rest (night)

### Commitment Flow

```
Player clicks "Weapon Drill (Midday)"
  ↓
CampOpportunityGenerator.CommitToOpportunity(opportunity)
  ↓
Stores commitment: {opportunityId, targetDecisionId, phase, day}
  ↓
Menu shows: "Weapon Drill [Scheduled for Midday]"
  ↓
Time passes... hourly tick at noon
  ↓
FireScheduledCommitments("Midday", currentDay)
  ↓
Notification: "It's midday. Time for weapon drill."
  ↓
Decision popup appears automatically
```

---

## Requirements System

Opportunities and decisions support rich requirement filtering:

### Time Requirements
```json
{
  "validPhases": ["Dawn", "Midday"],
  "scheduledPhase": "Midday"
}
```

### Location Requirements
```json
{
  "notAtSea": true,  // Only on land
  "atSea": true      // Only at sea
}
```

### Order Compatibility
```json
{
  "orderCompatibility": {
    "guard_duty": "risky",     // Can do, but might get caught
    "patrol": "blocked",       // Cannot do
    "default": "available"     // OK for other orders
  }
}
```

### Tier Requirements
```json
{
  "minTier": 2,  // Requires rank 2+
  "maxTier": 4   // Only for ranks 2-4
}
```

### Cooldowns
```json
{
  "cooldownHours": 24  // Can't repeat for 24 hours
}
```

---

## Content Variants Pattern

Opportunities can have sea/land variants that target the same decision:

**Land Opportunity:**
```json
{
  "id": "opp_rest_tent",
  "title": "Rest in Tent",
  "description": "Your bedroll looks inviting...",
  "targetDecision": "dec_rest_sleep",
  "notAtSea": true
}
```

**Sea Opportunity:**
```json
{
  "id": "opp_rest_hammock",
  "title": "Rest in Hammock",
  "description": "Your hammock sways with the ship's motion...",
  "targetDecision": "dec_rest_sleep",
  "atSea": true
}
```

Both target the same decision content, but present differently based on context.

---

## Learning System

`PlayerBehaviorTracker` learns preferences over time:

**Tracks:**
- Engagement rate per opportunity type (training, social, recovery, etc.)
- Preferred time of day for activities
- Risk tolerance (risky vs safe opportunities)

**Uses:**
- Boosts fitness scores for preferred opportunity types
- Reduces frequency of ignored opportunity types
- Adapts to player's playstyle

---

## Legacy Menu Sections

The Training, Social, and Camp Life menu sections remain for backwards compatibility but now show "(none available)" since all activities are orchestrated.

**Why Keep Them?**
- Smooth migration path
- Future potential for special player-initiated actions
- Familiar menu structure for players

**Future:** These sections may be removed entirely or repurposed for other content types.

---

## Implementation Notes

### No Static Decisions

As of 2025-12-31, decisions with `dec_` prefix are **not** player-initiated. They are event content triggered by opportunities.

**Before:**
- `dec_training_drill` appeared in Training menu section
- Player could click it anytime (subject to cooldowns)

**After:**
- `dec_training_drill` only fires when `opp_weapon_drill` opportunity is engaged
- Opportunity appears based on orchestrator logic (time, context, fitness)

### Decision Spam Prevention

When a decision is clicked, it's marked as "currently showing" to prevent spam-clicking:

```csharp
// When decision clicked
DecisionManager.Instance.MarkDecisionAsShowing(decision.Id);

// Menu checks this state
if (DecisionManager.Instance.IsDecisionCurrentlyShowing(decision.Id))
{
    // Disable menu entry, show "In progress..."
}

// When event popup closes
DecisionManager.Instance.ClearCurrentlyShowingDecision();
```

### Sea/Land Context

Decisions and opportunities filter by party location:

```csharp
var isAtSea = Campaign.Current?.MainParty?.IsCurrentlyAtSea ?? false;

if (opportunity.NotAtSea && isAtSea)
{
    // Hide opportunity - not available at sea
}

if (opportunity.AtSea && !isAtSea)
{
    // Hide opportunity - only available at sea
}
```

---

## Testing Scenarios

### Scenario 1: Dawn Training

**Setup:** Player is on land, dawn phase (6am), not on duty

**Expected:**
- Opportunities menu shows training options (weapon drill, formation practice)
- Player clicks "Weapon Drill (Midday)"
- Menu shows "Weapon Drill [Scheduled for Midday]"
- At noon, notification appears: "It's midday. Time for weapon drill."
- Decision popup appears automatically with drill options

### Scenario 2: At Sea

**Setup:** Player's party is at sea, dusk phase

**Expected:**
- Land-only opportunities hidden (archery range, foraging, tavern)
- Sea opportunities shown (below deck drinking, sea shanties)
- Opportunities reference ship context ("below deck", "on deck")

### Scenario 3: On Duty

**Setup:** Player is on guard duty, dusk phase

**Expected:**
- Risky opportunities marked (card game, drinking)
- Tooltip warns: "Gambling while on duty? If you're caught..."
- Detection check runs if player engages
- Blocked opportunities hidden (rest, patrol)

---

## Configuration

**File:** `ModuleData/Enlisted/Config/enlisted_config.json`

```json
{
  "orchestrator": {
    "activity_modifiers": {
      "Quiet": 0.5,
      "Routine": 1.0,
      "Active": 1.5,
      "Intense": 2.0
    },
    "max_opportunities_default": 3,
    "fitness_threshold": 40,
    "learning_rate": 0.1
  }
}
```

---

## Future Enhancements

### Phase 9: Decision Scheduling UI

**Goal:** Better UI for scheduled commitments

**Features:**
- Forecast section shows upcoming commitments
- Countdown timers
- Cancel commitment option (with fatigue penalty)
- Reminder notifications

### Phase 10: Order Forecasting

**Goal:** Advance warning before orders issue

**Features:**
- 24h forecast: "Sergeant's been making lists"
- 8h scheduled: "You're assigned to guard duty"
- 2h urgent: "Guard duty starts soon"
- Prevents missed orders at fast-forward speeds

---

**Last Updated:** 2025-12-31  
**Maintained By:** Project AI Assistant
